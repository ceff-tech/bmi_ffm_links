---
title: "<br>Wrangling Ridiculous River Data:"
subtitle: "Linking Biological Stream Condition with Flow Alteration"
author: "Ryan Peek, PhD<br><span style = 'font-size: 70%;'> UC Davis<br>Center for Watershed Sciences<br></span>"
date: '<span style = "font-size: 60%;">2022-Feb-10<br>`r icons::fontawesome("twitter")` [riverpeek](https://twitter.com/riverpeek)</span>'
output:
  xaringan::moon_reader:
    seal: false
    css: ["xaringan-themer.css", "peek_custom.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      beforeInit: "macros.js"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(flair)
library(icons)
library(here)
library(tidyverse)
library(xaringanthemer)

# theme the css
xaringanExtra::use_xaringan_extra(include = c("tile_view", "share_again", "editable"))
xaringanExtra::use_extra_styles(hover_code_line = TRUE, mute_unhighlighted_code = TRUE)

style_duo_accent(
  primary_color = "#1b9aaa",
  # darkblue: #002855, orange: #ffc43d, steelblue: #1b9aaa
  secondary_color = "#ffc43d",
  #title_slide_background_image = "flare_helix.png", 
  #title_slide_background_position = "bottom 490px left 250px",
  #title_slide_background_size = "40%",
  text_font_google = google_font("Roboto"),  #<< Playfair Display, Bebas Neue
  header_font_google = google_font("Sansita"), 
  link_color = "#C71585",
  #<< crazy: Trade Winds, Bangers, Julius Sans One, IBM Plex Sans Condensed
  text_font_size = "1.4rem",
  # add specific colors (access w .color[])
  colors = c(
  red = "#f34213",
  purple = "#3e2f5b",
  orange = "#ff8811",
  green = "#136f63",
  magenta = "#8B008B",
  white = "#FFFFFF")
  #title_slide_background_color = "steelblue"
)

# chunk defaults
knitr::opts_chunk$set(
  fig.showtext = TRUE,
  echo=FALSE, 
  fig.retina = 3, warning = FALSE, 
  message = FALSE,
  fig.width = 16,
  fig.height = 8,
  dpi = 300
)

```

class: center, top, inverse-black
background-image: url(images/041912_Panorama_NYUBA.jpg)
background-size: contain

# Wrangling Ridiculous River Data

### Linking Biological Stream Condition with Flow Alteration

<br><br><br><br><br><br>
.large[Ryan Peek | 2022 Feb 10 ]

<span style = "font-size: 100%;">`r icons::fontawesome("twitter")` [riverpeek](https://twitter.com/riverpeek)</span>

---

layout: true
  
<div class="my-footer"><span>2022 â€¢ @riverpeek</span></div> 


---
class: top, center, inverse
background-image: url("images/colfax_1891.png")
background-size: 80%
background-position: 50% 80%


## A winding path to data science (who am I)

---

# What I work on now

 - Conservation Genomics (lots of bioinformatics!)
 
--

 - Environmental Flows & Altered Rivers

--

 - Meadows & Restoration

--

 - Delta Foodweb Connectivity

--

 - ![:scale 5%](https://github.com/d-rug/logo/raw/master/DRUG_final_cobalt.png) [Davis R Users Group](https://d-rug.github.io) 

--

 - [R4WRDS](http://r4wrds.com)

--

 - Carpentries workshops
 
--

- Life!

---
class: center, middle, inverse

# Data in California

## an ever-present wave

![:scale 80%](images/email20monster.png)

---
class: center, middle

# So how can we use it for good? 

![](images/data_provenance_workflow_words.png)


---
class: top, inverse-black

## People think Data Science is...

```{r, echo=FALSE, out.width='85%', fig.align='center'}

knitr::include_graphics("https://media.wired.com/photos/5ca648a330f00e47fd82ae77/master/w_2560%2Cc_limit/Culture_Matrix_Code_corridor.jpg")

```
 
---
class: inverse, top
background-image: url(hexes/dplyr.png), url(hexes/sf.gif), url(hexes/tidyr.png)
background-position: 98% 2%, 92% 2%, 86% 2%
background-size: 5%, 5%, 5%


## Actual Data Science is this... 

```{r echo=F, eval=TRUE, out.width='70%'}

# these are all from Allison Horst: https://github.com/allisonhorst/stats-illustrations

# CITE AS: "Artwork by @allison_horst"

knitr::include_graphics(path="https://raw.githubusercontent.com/allisonhorst/stats-illustrations/master/rstats-artwork/data_cowboy.png")

```

.font60[
*Illustration by @allison_horst, from Hadley Wickham's talk 'The Joy of Functional Programming (for Data Science)'"*
]


 - [*see great visualization of same data 25 ways!*](https://flowingdata.com/2017/01/24/one-dataset-visualized-25-ways/)

---
class: center, top, inverse
name: rivers-intro
background-image: url('images/slate_ck_aerial_v2.png')
background-size: 70%
background-position: 50% 50%

<br>

# Rivers

--

<br><br>

## Dams

---
class: top, left
background-image: url('images/dams_in_west.png')
background-size: 50%
background-position: 100% 30%


.pull-left[

### Over 1,400 large dams in CA

 - 95% of streams of have altered flows (depleted or inflated)

 - competing demands for energy, agriculture, ecology

]

???

45% of salmonids to be extirpated by 2050, 75% extirpated by 2100

---
class: inverse, incremental
name: plot

# Environmental Flows

 - Many programs are attempting to set environmental flows...

--

 - CA is physically diverse & management needs vary

--

 - Coordination & sharing information between groups is challenging!

--

 - .red[Uncertainty] in most appropriate method

--

 - **Balancing ecological flow needs & other demands is hard**

---
class: top
name: functionalflows
background-image: url('images/ffcomponent_w_nfa_data.png')
background-size: contain

.right[
## .font80[Functional Flow Components]
.font60[ [(*Yarnell et al., 2020*)](https://onlinelibrary.wiley.com/doi/10.1002/rra.3575) ]
]

--

.pull-left.w40[

.font70[
**Flow Metrics**
 - Timing
 - Magnitude
 - Duration
 - Rate
 - Frequency
]

]
???

Aspects of flow regime that directly relate to ecological, geomorphic or biogeochemical processes in riverine systems

Expected to support foundational physical and ecological processes that sustain biological communities.

A functional flow regime recognizes ALL 5 components. No single component is a functional flow regime.

Biotic stress in dry season low flow period, abiotic in peak flow periods

---
class: top, left, inverse-black
background-image: url(images/yarnell_et_al_2020_ff.png)
background-size: contain

--

## .font70[Can calculate quantitative metrics based on hydrograph!]

--

## .font50[These are biologically relevant]

![](images/yarnell_et_al_2020_table1.png)


---
class: bottom, left, inverse-black
background-image: url(images/nfy_recession_bar.png)
background-size: cover

# Spring Recession!

---
class: top, left
background-image: url(images/yarnell_et_al_2010_biosci_fig6.png)
background-size: 50%
background-position: 95% 5%


## Seasonality of Flows

.font60[ [(*Yarnell et al., 2020*)](http://dx.doi.org/10.1525/bio.2010.60.2.6) ]

.pull-left[

 - Important .red[*function*] relates to biotic and abiotic change

]

---
class: top, left
background-image: url(images/yarnell_et_al_2010_biosci_fig6.png)
background-size: 50%
background-position: 95% 5%


## Seasonality of Flows

.font60[ [(*Yarnell et al., 2020*)](http://dx.doi.org/10.1525/bio.2010.60.2.6) ]

.pull-left[

- Important .red[*function*] relates to biotic and abiotic change
 
- .orange[Variability] is really important!

]


---

![](images/pre_cowplot_predic_seas_annot.png)

--

![](images/post_cowplot_predic_seas_annot.png)

---
class: inverse, center, middle

## Now: <br> Large & Messy Datasets


![mess](https://media.giphy.com/media/KE9cblgPK6EPS/giphy.gif)


---
class: top, left

# Functional Flow Calculator

 - Available at [eflow.ucdavis.edu](https://eflows.ucdavis.edu)
 
--
 
 - `R` **FFC** Calculator: [https://ceff-tech.github.io/ffc_api_client/](https://ceff-tech.github.io/ffc_api_client/)

--

 - [TNC Rivers for Nature](https://rivers.codefornature.org/#/map)

---
class: center

# .black[Biological Stream Condition Data]

--

.pull-left[

### .orange[CSCI (California Stream Condition Index)]

.left[
- over 300,000 samples from 1994-2018
- many stations across the state
- [Mazor et al., 2016](https://www.journals.uchicago.edu/doi/10.1086/684130)
]
]

--

.pull-right[

### .green[ASCI (Algal Stream Condition Index)]

.left[
- .font70[ [Theroux et al., 2020](https://www.sciencedirect.com/science/article/pii/S1470160X20303587?via%3Dihub) ]
![](images/theroux_2020_fig6_map.png)

]
]

---
class: center, bottom

### CSCI Scores Variable by site and season

![](images/01_raw_csci_score_by_month.png)

---
class: middle, inverse
background-image: url(images/03_tmap_all_bio_sites.png)
background-size: contain
background-position: 100% 50%

.pull-left[

### Biological Sites
###.font80[Many sites, but not all overlapped!]

]

---
class: middle, inverse
background-image: url(images/03_tmap_usgs_sites_all.png)
background-size: contain
background-position: 100% 50%

.pull-left[

### USGS gages across California

### .font80[Variable data intervals]

### .font80[Different date ranges]

]

---
class: top

## Helpful bits (but many many more!)

.pull-left[

![](../slides/hexes/sf.gif) 
```{r, out.width="40%"}
knitr::include_graphics("../slides/hexes/mapview.gif")
```

```{r, out.width="50%"}
knitr::include_graphics("../slides/hexes/dplyr.png")
```
```{r, out.width="30%"}
knitr::include_graphics("../slides/hexes/ropensci.png")
```

]

.pull-right[

```{r, out.width="47%"}
knitr::include_graphics("../slides/hexes/nhdplusTools.png")
```
```{r, out.width="30%"}
knitr::include_graphics("../slides/hexes/purrr.png")
```
```{r, out.width="30%"}
knitr::include_graphics("../slides/hexes/readr.png")
```
```{r, out.width="40%"}
knitr::include_graphics("../slides/hexes/ggplot2.png")
```
]

---
class: inverse

## Real Life: 

Merging datasets...is messy

.center[
```{r, out.width="70%"}
knitr::include_graphics("images/Messy_storage_room_with_boxes.jpg")
```
]

---
class: inverse-black

## General Approach: Write Steps

.pull-left.w60[

![](images/fig-1_analysis_flowchart.jpg)

]

--


.pull-right.w30[
.font70[Lots of waiting and iteration though!]

![waiting](https://media.giphy.com/media/d7N3tZcLEJW4zvua1o/giphy.gif)

]

---

## Mapview: Map of Sites

[Open map here](images/03_map_of_final_bmi_csci_sites.html)

```{r echo=TRUE, eval=FALSE}

library(mapview)
library(dplyr)

# set background basemaps:
basemapsList <- c("Esri.WorldTopoMap", "Esri.WorldImagery","Esri.NatGeoWorldMap",
                  "OpenTopoMap", "OpenStreetMap", "CartoDB.Positron")
mapviewOptions(basemaps=basemapsList, fgb=FALSE) #<<

# map
m3 <- mapview(bmi_final_dat, cex=6, col.regions="orange",layer.name="Selected BMI CSCI") +
  mapview(mainstems_all %>% filter(from_gage=="UM"), color="forestgreen", cex=3, layer.name="NHD Flowlines US") + 
  mapview(mainstems_distinct, color="steelblue", cex=3, layer.name="NHD Flowlines DS") +
  mapview(gages_selected_v2, col.regions="skyblue", cex=7, color="blue2", layer.name="Selected USGS Gages") +
  # these are all bmi or gages in same H12 but not selected
  mapview(gages_not_selected_v2, col.regions="slateblue", color="gray20", cex=3.2, layer.name="Other USGS Gages") +
  mapview(bmi_not_selected_v2, col.regions="gold", color="gray20", cex=3.2, layer.name="Other BMI Sites in H12") +
  mapview(hucs_selected_v2, col.regions="orange3", alpha.region=0.1, color="orange", legend=F, layer.name="Selected HUC12") +
  mapview(hucs_not_selected_v2, col.regions="dodgerblue", alpha.region=0.1, color="darkblue", legend=F, layer.name="Other HUC12")
```

---
class: left, top, inverse
background-image: url(images/03_tmap_selected_bio_sites_combined_wgages.png)
background-size: contain
background-position: 100% 50%

# Final Sites

.pull-left.w40[
- represent multiple regions
- but meager in some places
]

---
class: left, top, inverse
background-image: url(images/03_tmap_selected_bio_sites_strmclass.png)
background-size: contain
background-position: 100% 50%

## Stream Classes

.pull-left.w40[
- Collapsed to 3 (based on Patterson et al. 2020)

- Spatial Joins are amazing
]


---
class: inverse-black, middle, center

# Results!

![excited llama](https://media.giphy.com/media/yndnaM3VpQahG/giphy.gif)
]

---
class: inverse, top

# Results

 - seasonality one of strongest factors
 
--

 - as was Fall Pulse and Dry Season Baseflows
 
--

 - published some stuff

--

![](images/peek_et_al_2022_ffm.png)

---
class: left, top
background-image: url(images/fig4_boxplot_of_asci_csci_ffm_by_deltaH.jpg)
background-size: 90%

???

Normalized delta hydrology (departure from reference value). The solid pink line in the background indicates no difference between the observed 50th percentile and the predicted reference 50th percentile metric value. Values to the left of the line are reduced or early, and values to the right are inflated or late, relative to the expected reference value.

---
class: left, inverse, top
background-image: url(images/fig8_gbm_combined_snow_rain_mixed_seasonality_all_ri_sized_points_w_lines_horiz_v2.jpg)
background-size: contain
background-position: 100% 50%

---
class: center, inverse-black

# Thanks!

![](images/Picture1.jpg)