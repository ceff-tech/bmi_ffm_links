---
title: "Analysis Workflow for BMI/ASCI vs. FFM"
author: "R. Peek"
date: "Updated: `r format(Sys.Date())`"
output: 
  html_document:
    highlight: pygments
    theme: yeti
    toc: yes
    toc_float: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

suppressPackageStartupMessages({
  library(tidyverse);
  library(sf);
  library(leaflet);
  library(here);
  library(mapview)
})

```

## Analysis Pipeline

This provides an overview of the steps required to assess functional flow metrics in relation to BMI and ASCI ecological data. The basic overview requires spatially linked ecological stream data and associated functional flow metrics (FFM) for a given stream or stream segment.

### Steps to Pair BMI/ASCI Sites with Flow Sites

 - Clean BMI Data (`00_read_in_bmi_data.R`, `01_make_ref_station_BMI_data.R`)
 - Clean USGS Data (`02_read_in_gage_list.R`)
 - Join Spatially (`03_link_spatial_bmi_w_gages.R`)
    - Filter to sites within same HUC12
    - Get mainstem COMIDs for upstream/downstream NHD segments
    - Select only BMI sites that are on mainstem of USGS gage
    - Distance filter?
 - Join Temporally
    - Make sure flow data overlaps with ecological (BMI) data, flow > 1994 (`05_calc_por_flow_match_merge_yrs_bmi.R`)
    


```{r}
library(DiagrammeR)

# left to right mermaid

DiagrammeR("graph TB;
  A(<b>CSCI:</b> Collect & Clean <br> BMI Data) 
  B(<b>USGS:</b> Download & Clean <br> Reference Gage Data) 
  C[Filter Temporally]
  D((Gage / BMI points <br>in same HUC12))
  E>Identify BMI COMID Points] 
  F>Select COMIDs in same NHD mainstem streamline]
  G{<b><i>COMID not in<br> mainstem streamline</b></i>}
  H(BRT Models of BMI Response vs. FF Metrics)
  I(Identify metrics <br> that are best predictors of <br> seasonality or indicators of alteration)
  
  
  A-.->|<i>QA/QC</i>|C
  B-.->|<i>>10 years of data</i>|C
  C-- <i>Gage Data/BMI Data Post 1994</i>-->D
  D -->E
  E -->F
  E -->G
  F -->H
  subgraph BRT Modeling
    H-- MODELING -->I
  end
  style A fill:#ffa500,stroke:#333,stroke-width:4px
  style B fill:#0099ff,stroke:#333,stroke-width:4px
  style H fill:#0033gg,stroke:#333,stroke-width:4px
  ")

```



### Next Steps

 1. Get impaired and unimpaired gages (GAGES2) and pair with all BMI sites (**spatially**)
 2. Get impaired FFC Metrics with BMI metrics
    - CSCI
    - % Intolerant
    - MMI
    - Shannon's
    - EPT
 3. Get regions and bin (use HUC4)
 4. Run statewide analysis
 5. Run regional analysis
 
 **Outcomes**:
 
  1. **REFERENCE** using unimpaired get best predictors of seasonality/unimpaired system (statewide)
  2. **ALTERATION** using altered/unimpaired together, get best metrics that indicate alteration (statewide/regionally)
  3. **TREND/RELATIONSHIP** predictive bayesian mixed model/regression models that use best/top metrics to assess relationships with given response metrics (regional)
  4. **APPLICATION/MANAGEMENT** how to use/interpret this approach in management application  
      - *No Pre-existing Data/Knowledge*: Prioritization of function components or metrics. So target is within the predicted range for specific segment
      - *Monitoring/Assessment*: how does management change/improve function flows for ecological responses? e.g., implement recession rate and see improvement/increase in targeted response (diversity/abundance/CSCI score)?
 
