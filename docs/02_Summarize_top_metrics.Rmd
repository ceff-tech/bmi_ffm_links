---
title: "BRT BMI-Flow Metrics"
date: "Updated: `r format(Sys.Date())`"
output: 
  html_document:
    highlight: pygments
    theme: yeti
    toc: yes
    toc_float: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

suppressPackageStartupMessages({
  library(tidyverse);
  library(sf);
  library(leaflet);
  library(here)
})


```


```{r getData}

# get data from BRT outputs
load(paste0(here(), "/data_output/gbm_bmi_metrics_RI_combined.rda"))
load(paste0(here(), "/data_output/selected_bmi_stations_w_comids.rda"))
load(paste0(here(), "/data_output/maintems_us_ds_selected_gages.rda"))
load(paste0(here(),"/data_output/selected_bmi_flow_metrics_w_csci_ANN.rda"))
load(paste0(here(),"/data_output/selected_bmi_flow_metrics_w_csci_POR.rda"))
load(paste0(here(),"/data_output/selected_bmi_flow_metrics_w_csci_LAG1.rda"))
load(paste0(here(),"/data_output/selected_bmi_flow_metrics_w_csci_LAG2.rda"))
load(paste0(here(),"/data_output/sel_bmi_and_gages.rda"))
load(paste0(here(),"/data_output/selected_h12_contain_bmi_gage.rda"))

```

## Main Questions

This part is most germane to the dataset we currently have (reference flow gages and all BMI data)
<i>

  -	What is the range/distribution of CSCI/ASCI scores at sites with reference hydrology?
      -	What functional flow metrics (or components) are most predictive of differences in biology at reference gages?

</i>      

This second part (reference and non-reference) will need to wait until we have non-reference data generated from non-reference gages across the state.

## Flow Metrics

The flow metrics calculated for each reference gage:

<script>
function myFunction() {
    var x = document.getElementById("myDIV");
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>
 
<button onclick="myFunction()">Show/Hide Metrics</button>
 
<div id="myDIV">

**Annual**

  > - Avg annual flow (`Avg`)
  > - Coefficient of variation (`CV`)
  > - Standard deviation (`Std`)

**Spring Recession**

  > - Duration (`SP_Dur`)
  > - Magnitude (`SP_Mag`)
  > - Rate of change (`SP_ROC`)
  > - Timing (`SP_Tim`)

**Dry Season Low Flow**

 > - Duration (`DS_Dur_WS`)
 > - Magnitude10yr (`DS_Mag_10`)
 > - Magnitude50yr (`DS_Mag_50`)
 > - No flow days (`DS_No_Flow`)
 > - Timing (`DS_No_Flow`)

**Fall Flush Flow**

 > - Duration (`WSI_Dur`)
 > - Magnitude (`WSI_Mag`)
 > - Timing (`WSI_Tim`)
 > - Wet season timing (`Wet_Tim`)
 
**Peak Magnitude High Flows (5 exceedance rates) **

 > - Peak Mag 2 (`Peak_Mag_2`)
 > - Peak Mag 5 (`Peak_Mag_5`)
 > - Peak Mag 20 (`Peak_Mag_20`)
 > - Peak Duration 2 (`Peak_Dur_2`)
 > - Peak Duration 5 (`Peak_Dur_5`)
 > - Peak Duration 10 (`Peak_Dur_10`)
 > - Peak Duration 20 (`Peak_Dur_20`)
 > - Peak Duration 50 (`Peak_Dur_50`)
 > - Peak Frequency 2 (`Peak_Fre_2`)
 > - Peak Frequency 5 (`Peak_Fre_5`)
 > - Peak Frequency 10 (`Peak_Fre_10`)
 > - Peak Frequency 20 (`Peak_Fre_20`)
 > - Peak Frequency 50 (`Peak_Fre_50`)
 > - Peak Timing 2 (`Peak_Tim_2`)
 > - Peak Timing 5 (`Peak_Tim_5`)
 > - Peak Timing 10 (`Peak_Tim_10`)
 > - Peak Timing 20 (`Peak_Tim_20`)
 > - Peak Timing 50 (`Peak_Tim_50`)
 > - Wet BFL Magnitude (`Wet_BFL_Mag`)
 
</div>
 
 
## CSCI Scores across Stream Classes

There is a wide range of CSCI scores across the sites selected, here we look at Stream Class vs. CSCI Percentile. The mean CSCI percentile across all sites is `r mean(bmi_flow_metrics_ann_csci$csci_percentile, na.rm = T)`.

Here we can look at all the stream classes, and then re-bin based on **snowmelt**, **mixed**, and **rain_driven**.
 
```{r boxplots}

library(forcats)

# 1=SM (Snowmelt)
# 2=HSR (High Snow Rain)
# 3=LSR (Low Vol Snow Rain)
# 4=WS (Winter Storms)
# 5=GW (Groundwater)
# 6=PGR (Perennial GW & Rain)
# 7=FER (Flashy & Ephemeral)
# 8=RGW (Rain seasonal GW)
# 9=HLP (High Elev Low Precip)

bmi_flow_metrics_ann_csci$stream_class <-
  factor(bmi_flow_metrics_ann_csci$stream_class, 
         levels = c("Class-1", "Class-3", "Class-4",
                    "Class-6", "Class-7", "Class-8"))

fct_count(bmi_flow_metrics_ann_csci$stream_class)

# plot CSCI percentile no NAs
ggplot(data=bmi_flow_metrics_ann_csci, 
       aes(x=stream_class, y=csci_percentile)) + 
  geom_boxplot(aes(fill=stream_class), show.legend = F, 
               varwidth = TRUE) +
  ylab("CSCI (Percentile)") + xlab("Stream Class") +
  theme_classic(base_family = "Roboto Condensed")

# collapse factors
bmi_flow_metrics_ann_csci$stream_class_coll <-
  fct_collapse(bmi_flow_metrics_ann_csci$stream_class,
               snowmelt=c("Class-1"), # "Class-9",
               rain_driven=c("Class-4","Class-6","Class-7","Class-8"),
               mixed = c( "Class-3")) #"Class-5", "Class-2"

fct_count(bmi_flow_metrics_ann_csci$stream_class_coll)


# plot CSCI percentile no NAs
ggplot(data=bmi_flow_metrics_ann_csci, 
       aes(x=stream_class_coll, y=csci_percentile)) + 
  geom_boxplot(aes(fill=stream_class_coll), show.legend = F, 
               varwidth = TRUE) +
  ylab("CSCI (Percentile)") + xlab("Stream Class") +
  theme_classic(base_family = "Roboto Condensed")


```


### CSCI By Flow Dataset

The main datasets we looked at were **Annual**, **Lag-1**, and **Lag-2**. **Annual** used data from USGS gages that matched the exact same year as the BMI stations. **Lag-1** was flow data from the year prior to the BMI sampling year, and **Lag-2** is flow data from 2 years prior to the BMI sampling year.

```{r plots, echo=F, eval=F}

# most common variable?
bmi_RI_combined %>% group_by(Ymetric, flowdat, var) %>% 
  summarize(meanRI = mean(rel.inf)) %>% 
  top_n(3) %>% 
  arrange(Ymetric, desc(meanRI)) %>% 
  filter(flowdat=="annual") %>% 
  ggplot(.) +
  geom_col(aes(x=forcats::fct_reorder(var, meanRI), y=meanRI, fill=Ymetric)) + 
           #position="dodge", width = .5) +
  coord_flip() +
  scale_fill_viridis_d()+
  xlab("") + ylab("Mean Relative Inf (%)") +
  theme_classic(base_family = "Roboto Condensed") +
  facet_grid(flowdat~.)

ggsave(filename = "figs/stacked_barplot_RI_by_metric_annual.png", width = 6, height = 6, units = "in", dpi = 200)


# most common variable?
bmi_RI_combined %>% group_by(Ymetric, flowdat, var) %>% 
  summarize(meanRI = mean(rel.inf)) %>% 
  top_n(3) %>% 
  arrange(Ymetric, desc(meanRI)) %>% 
  filter(flowdat=="lag1") %>% 
  ggplot(.) +
  geom_col(aes(x=forcats::fct_reorder(var, meanRI), y=meanRI, fill=Ymetric)) + 
           #position="dodge", width = .5) +
  coord_flip() +
  scale_fill_viridis_d()+
  xlab("") + ylab("Mean Relative Inf (%)") +
  theme_classic(base_family = "Roboto Condensed") +
  facet_grid(flowdat~.)

ggsave(filename = "figs/stacked_barplot_RI_by_metric_lag1.png", width = 6, height = 6, units = "in", dpi = 200)


# most common variable?
bmi_RI_combined %>% group_by(Ymetric, flowdat, var) %>% 
  summarize(meanRI = mean(rel.inf)) %>% 
  top_n(3) %>% 
  arrange(Ymetric, desc(meanRI)) %>% 
  filter(flowdat=="lag2") %>% 
  ggplot(.) +
  geom_col(aes(x=forcats::fct_reorder(var, meanRI), y=meanRI, fill=Ymetric)) + 
           #position="dodge", width = .5) +
  coord_flip() +
  scale_fill_viridis_d()+
  xlab("") + ylab("Mean Relative Inf (%)") +
  theme_classic(base_family = "Roboto Condensed") +
  facet_grid(flowdat~.)

ggsave(filename = "figs/stacked_barplot_RI_by_metric_lag2.png", width = 6, height = 6, units = "in", dpi = 200)

```



```{r flipplots, echo=F, }

library(stringr)
#devtools::install_github("walkerke/bsselectR")
# see here: https://walkerke.github.io/
library(bsselectR)

bar_plots <- paste0(list.files(path = paste0(here(),"/figs"), pattern = "stacked_barplot_RI_by_metric",  full.names = TRUE))
names(bar_plots) <- c("Annual", "Lag1", "Lag2")
#bar_plots

bsselect(vector = bar_plots, type = "img", selected = "Annual", 
         live_search = TRUE, show_tick = TRUE, frame_height = "700",
         frame_width = "800", 
         )

```




## Top Variables from BRT

Top 3 flow metrics that explained the most variation in BMI metrics, across each flow data set (*Annual, 1-year Lag, 2-year Lag*). Boosted regression trees generate a *"Relative Importance"* metric which provides a measure of how important a given variable is in describing variance in the response. Models were run for each of the following BMI response metrics, and sampling dates were matched with the appropriate sample dates for the flow metrics.

 - `CSCI_percentile`
 - `Shannon_Diversity`
 - `Taxonomic_Richness`
 - `EPT_Percent`
 - `Tolerant_Percent`
 
```{r topVars, message=F, warning=F}

# most common variable?
bmi_RI_combined %>% group_by(flowdat, var) %>% 
  summarize(meanRI = mean(rel.inf)) %>% 
  top_n(3) %>% 
  arrange(flowdat, desc(meanRI)) %>% knitr::kable()

```


```{r}
library(DT)

DT::datatable(bmi_RI_combined)

```


<!--
```{r staticMap, warning=FALSE, message=FALSE}

library(tmap)
library(USAboundaries)

ca <- USAboundaries::us_states(states="CA")

load(paste0(here(), "/data_output/selected_bmi_flow_metrics_w_csci_ANN.rda"))

bmi_flow_metrics_ann_csci <- bmi_flow_metrics_ann_csci %>% 
  st_as_sf(coords=c("lon", "lat"), crs=4326, remove=F) %>% 
  mutate(Peak_Mag_5_log = log(ifelse(is.na(bmi_flow_metrics_ann_csci$Peak_Mag_5), 1, bmi_flow_metrics_ann_csci$Peak_Mag_5)))

pal = RColorBrewer::brewer.pal(name = "RdYlBu", n = 11)

tm_shape(ca) + tm_polygons(alpha=0.5, border.col="gray", lwd=4) +
tm_shape(bmi_flow_metrics_ann_csci) + 
  tm_bubbles(shape = 21, col="Peak_Mag_5_log", size=1, palette=viridis::viridis(10), n=10)


```
-->


## Leaflet Map
```{r leafletMap}

library(leaflet)

load(paste0(here(), "/data_output/selected_bmi_flow_metrics_w_csci_ANN.rda"))
#load(paste0(here(), "/data_output/selected_bmi_flow_metrics_w_csci_POR.rda"))
#load(paste0(here(), "/data_output/selected_bmi_flow_metrics_w_csci_LAG1.rda"))
#load(paste0(here(), "/data_output/selected_bmi_flow_metrics_w_csci_LAG2.rda"))

# assign a color
pal = colorNumeric("RdYlBu", domain = log(ifelse(is.na(bmi_flow_metrics_ann_csci$Peak_Mag_5), 1, bmi_flow_metrics_ann_csci$Peak_Mag_5)))

# Make a leaflet map!
m <- leaflet(bmi_flow_metrics_ann_csci) %>% addTiles() %>% 
  addProviderTiles("Stamen.TonerBackground", group = "Stamen Background") %>% 
  addProviderTiles("Esri.WorldImagery", group = "ESRI Aerial") %>%
  addProviderTiles("Esri.WorldTopoMap", group = "Topo") %>%
  
  # add scale bar
  addMeasure(position = "topright",
             primaryLengthUnit = "meters",
             primaryAreaUnit = "sqmeters",
             activeColor = "#3D535D",
             completedColor = "#7D4479") %>%
  
  
  # CDEC SNOW STATIONS
  addCircleMarkers(data=bmi_flow_metrics_ann_csci, group="BMI Coms",
                   lng=~lon, lat=~lat,
                   popup=paste0("<strong>","StationID: ","</strong>", 
                                bmi_coms$StationCode, 
                                "<br><strong>", "Lat: ","</strong>", 
                                bmi_coms$lat, 
                                "<br><strong>", "Lon: ","</strong>", 
                                bmi_coms$lon),
                   stroke=TRUE, weight=0.6,radius=5,
                   fillOpacity = 0.9, col = ~pal(log(bmi_flow_metrics_ann_csci$Peak_Mag_5))) %>% 
  
  addLegend(title = "log(Peak_Mag_5)", pal = pal, values = ~log(bmi_flow_metrics_ann_csci$Peak_Mag_5)) %>% 
                   #fillColor= "maroon") %>%  
  
  addLayersControl(
    baseGroups = c("Stamen Background", "ESRI Aerial", "Topo"),
    overlayGroups = c("BMI Coms"),
    options = layersControlOptions(collapsed=T)
  )

m


```
