---
title: "Analysis Workflow for BMI/ASCI vs. FFM"
author: "R. Peek"
date: "Updated: `r format(Sys.Date())`"
output: 
    html_document:
      highlight: pygments
      theme: yeti
      toc: yes
      toc_float: true
      code_folding: hide
---

```{r setup, include=FALSE}
#knitr::opts_chunk$set(fig.retina=2)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
#knitr::opts_chunk$set(cache = FALSE)

# can tweak theme with "hrbrthemes::ipsum:" below output
#library(hrbrthemes)
#library(tidyverse)
#update_geom_font_defaults(font_rc)

```

## Assessing Flow Alteration with CSCI

A critical component of implementing environmental flows in California is quantifying the extent and degree of alteration in relation to biological assessment data. The CSCI is an index which represents biological condition at a given samplign site or stream segment, and has been developed using regional data with a standardized methodology. Thus it is a suitable metric to use for statewide analyses. 

The objective of this analysis was to use the functional flow metrics developed in CEFF (see figure) in an objective ecological context. Ultimately managers would like to know which metrics they should focus on for assessing and monitoring. By identifying which flow metrics are linked with alteration in an ecological context (e.g., CSCI), managers may focus management efforts more effectively depending on the conservation objective. By linking flow data from both altered and reference sites with biological assessment data, we can identify the FF metrics that best indicate alteration at both regional and statewide scales.

```{r echo=FALSE, eval=TRUE, out.width='60%'}

knitr::include_graphics(paste0(here::here(),"/docs/fig2A_ff_components.png"))

```

## CSCI vs. FFM Analysis Pipeline

This provides an overview of the steps required to assess functional flow metrics in relation to BMI and ASCI ecological data. The basic overview requires spatially linked ecological stream data and associated functional flow metrics (FFM) for a given stream or stream segment.

### Steps to Pair BMI/ASCI Sites with Flow Sites

1. Get Data (`00_get_raw_bmi_data.R`, `00_clean_BMI_station_data.R`)
2. Clean Data (`01_clean_BMI_station_data.R`, `01_clean_USGS_ref_gage_data.R`)
3. Join Spatially (`02_link_bmi_all_gages_spatially.R`)
    - Filter to sites within same HUC12 as USGS gage
    - Get mainstem COMIDs for USGS gage upstream/downstream NHD segments
    - Select only BMI sites that are on same mainstem COMID list as associated USGS gage
    - Distance filter is currently downstream only, within 10 km
    - View Maps (`03_view_final_selected_sites_ALL`)
4. Join Temporally with Flow Data
    - Make sure flow data overlaps with ecological (BMI) data, flow > 1994 (`04_get_flow_metric_datasets_ALL.R`)


```{r diagrams, eval=FALSE, include=FALSE}

library(DiagrammeR)
library(htmltools)

mermaid(paste0(here::here(),"/docs/analysis_flowchart_spatial_join.mmd"))

```

```{r spatialWorkflow}

knitr::include_graphics(paste0(here::here(),"/figs/analysis_flow_chart_spatial_join.png"))
```

### Calculate Alteration Status

Once we have flow metric data for our paired (BMI-USGS) sites, we need to quantify alteration status based on the functional flow metrics. The California Environmental Flow Framework and associated working group developed the following rules that were applied across the functional flow metrics to determine whether a metric at a site or stream segment could be quantified as altered in comparison to the reference data. The following categories and associated rules were developed:

####  **LIKELY UNALTERED:**
 
  1. If <font color="blue">**observed**</font> median value falls within <font color="maroon">**predicted 10th-90th percentile interval**</font> (i.e., <font color="maroon">**`i80r` predicted percentiles**</font>) of reference-based FFM values **AND**
  2. more than 50% of <font color="blue">**observed**</font> values fall within <font color="maroon">**`i80r` predicted percentiles**</font>, then FFM is considered “likely unaltered”

#### **LIKELY ALTERED:**

  3. If <font color="blue">**observed**</font> median value falls outside of reference-based <font color="maroon">**`i80r` predicted percentiles**</font>, then FFM is considered “likely altered”. Specify direction of alteration (e.g., depleted/augmented, early/late, high/low, long/short)
 
#### **INDETERMINATE:**

 4. If median <font color="blue">**observed**</font> value falls within <font color="maroon">**`i80r` predicted percentiles**</font> **AND** 
 5. fewer than 50% of current values fall within <font color="maroon">**`i80r` predicted percentiles**</font>, then FFM is considered “indeterminate”


## Primary Objectives

**At Paired sites (spatial and temporal):**

  1. Take observed FFM from annual, POR, and lagged data vs. predicted FFM and generate alteration "status" (-1=likely altered, 0=indeterminant, 1=likely unaltered)
      - for period of record, we can use both median values within I80R (between 10/90) and 50% of observations fall in I80R (if no, then indeterminant)
      - for annual/lag1/lag2, use 1 value is within interdecile range (between 10/90%), if yes = 1, if no=0. No indeterminant
      - for lagged, how many years previously was it in or out?
  2. BRT model CSCI vs. FFM status to assess which metrics best describe the gradient of alteration
  3. Stop and have 4-5 FFM that are important, what do those look like at altered sites? What is directionality of alteration (depleted or augmented)?

### Outcomes:

 - If you care about CSCI score as an ecological objective, these are the metrics that you should focus on refining/assessing/monitoring?

 - These flow metrics tend to be important, typically lower CSCI scores are associated with lower flow metrics or higher alteration

 - Or flow metrics are associated with lag years and more responsive.
 
### Applications  

**APPLICATION/MANAGEMENT** how to use/interpret this approach in management application  
      - *No Pre-existing Data/Knowledge*: Prioritization of function components or metrics. So target is within the predicted range for specific segment
      - *Monitoring/Assessment*: how does management change/improve function flows for ecological responses? e.g., implement recession rate and see improvement/increase in targeted response (diversity/abundance/CSCI score)?

 
 
```{r bib, include=FALSE}

# KEEP THIS AT THE END OF THE DOCUMENT TO GENERATE A LOCAL bib FILE FOR PKGS USED
knitr::write_bib(sub("^package:", "", grep("package", search(), value=TRUE)), file='skeleton.bib')

```