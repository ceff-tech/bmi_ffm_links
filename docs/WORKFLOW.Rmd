---
title: "Analysis Workflow for BMI/ASCI vs. FFM"
author: "R. Peek"
date: "Updated: `r format(Sys.Date())`"
output: 
    html_document:
      highlight: pygments
      theme: yeti
      toc: yes
      code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

```

## Analysis Pipeline

This provides an overview of the steps required to assess functional flow metrics in relation to BMI and ASCI ecological data. The basic overview requires spatially linked ecological stream data and associated functional flow metrics (FFM) for a given stream or stream segment.

### Steps to Pair BMI/ASCI Sites with Flow Sites

1. Get Data (`00_get_raw_bmi_data.R`, `00_clean_BMI_station_data.R`)
2. Clean Data (`01_clean_BMI_station_data.R`, `01_clean_USGS_ref_gage_data.R`)
3. Join Spatially (`02_link_bmi_all_gages_spatially.R`)
    - Filter to sites within same HUC12 as USGS gage
    - Get mainstem COMIDs for USGS gage upstream/downstream NHD segments
    - Select only BMI sites that are on same mainstem COMID list as associated USGS gage
    - Distance filter is currently downstream only, within 10 km
    - View Maps (`03_view_final_selected_sites_ALL`)
4. Join Temporally with Flow Data
    - Make sure flow data overlaps with ecological (BMI) data, flow > 1994 (`04_get_flow_metric_datasets_ALL.R`)


```{r, eval=FALSE, echo=FALSE}

library(DiagrammeR)

# left to right mermaid

DiagrammeR("graph TB;
  A(<b>CSCI:</b> Collect & Clean <br> BMI Data) 
  B(<b>USGS:</b> Download & Clean <br> Reference Gage Data) 
  C[<b>Join Spatially</b>]
  D((Gage / BMI points <br>in same HUC12))
  E(Get NHD Flowline COMIDs for BMI and USGS Points) 
  F>Filter to BMI COMIDs in same <br> NHD mainstem streamline as USGS gages]
  G{<b>STOP:</b> <br><br> BMI COMID not on <br>mainstem USGS <br>streamline}
  H(<b>Calculate BMI Metrics</b>)
  I(<b>Calculate Functional Flow Metrics <br> for selected Gages</b>)
  J(<b>Boosted Regression Tree Modeling:</b><br> BMI Metrics:<br><ul><li>EPT</li><li>Predators</li><li>Coleoptra</li><li>Clingers</li><li>Tax. Richness</li><li>% Intolerant</li></ul>)
  K(Alteration Models: Identify metrics that most strongly indicate flow alteration)
  
  
  A-.->|<i>QA/QC</i>|C
  B-.->|<i>>10 years of data</i>|C
  C -->D
  D -->E
  E -->F
  E -->G
  F -->H
  F -- <i>Filter to Flow Data >1994 <br> to match ecological data period </i>-->I
  H -->J
  I -->J
  J -- <i><b>ALTERATION Models</b></i> -->K
  
  style A fill:#ffd996,stroke:#f09b00,stroke-width:4px
  style B fill:#a5a5ff,stroke:#0000a5,stroke-width:4px
  style H fill:#ffd996,stroke:#f09b00,stroke-width:4px
  style I fill:#a5a5ff,stroke:#0000a5,stroke-width:4px
  style G fill:#ffc0cb,stroke:#b40000,stroke-width:4px
  ")

```


### Next Steps

 1. Get impaired FFC Metrics with BMI metrics and generate FFM status (-1,0,1)
 2. Decide which BMI metrics to assess/use:
    - **CSCI** = measure of departure from reference, anchored to a single site
    - **MMI** = measure of departure from reference, anchored along a gradient with stressed sites, will be more sensitive to flow alteration
 3. Get regions and bin (use HUC4?)
 4. Run statewide analysis
 5. Run regional analysis
 
 **Outcomes**:
 
  1. **REFERENCE** using unimpaired get best predictors of seasonality/unimpaired system (statewide)
  2. **ALTERATION** using altered/unimpaired together, get best metrics that indicate alteration (statewide/regionally)
  3. **TREND/RELATIONSHIP** predictive bayesian mixed model/regression models that use best/top metrics to assess relationships with given response metrics (regional)
  4. **APPLICATION/MANAGEMENT** how to use/interpret this approach in management application  
      - *No Pre-existing Data/Knowledge*: Prioritization of function components or metrics. So target is within the predicted range for specific segment
      - *Monitoring/Assessment*: how does management change/improve function flows for ecological responses? e.g., implement recession rate and see improvement/increase in targeted response (diversity/abundance/CSCI score)?
 

## Primary Objectives

**At Paired sites (spatial and temporal):**

  1. Take observed FFM from annual, POR, and lagged data vs. predicted FFM and generate alteration "status" (-1=likely altered, 0=indeterminant, 1=likely unaltered)
      - for period of record, we can use both median values within I80R (between 10/90) and 50% of observations fall in I80R (if no, then indeterminant)
      - for annual/lag1/lag2, use 1 value is within interdecile range (between 10/90%), if yes = 1, if no=0. No indeterminant
      - for lagged, how many years previously was it in or out?
  2. BRT model CSCI vs. FFM status to assess which metrics best describe the gradient of alteration
  3. Stop and have 4-5 FFM that are important, what do those look like at altered sites? What is directionality of alteration (depleted or augmented)?

### Outcomes:

 - If you care about CSCI score as an ecological objective, these are the metrics that you should focus on refining/assessing/monitoring?

 - These flow metrics tend to be important, typically lower CSCI scores are associated with lower flow metrics or higher alteration

 - Or flow metrics are associated with lag years and more responsive.